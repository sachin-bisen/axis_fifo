import esdl;
import uvm;
import fifo_intf: fifo_intf;

class Top: Entity
{
    import Vaxis_fifo_euvm;

    import esdl.intf.verilator.verilated;

    VerilatedVcdD _trace;

    
  Signal!(ubvec!1) rst;
  Signal!(ubvec!1) clk;

  DVaxis_fifo dut;

  fifo_intf fifo_in;
  fifo_intf fifo_out;

  void opentrace(string vcdname) {
    version (DUMPVCD) {
      traceEverOn(true);
      if (_trace is null) {
        _trace = new VerilatedVcdD();
        dut.trace(_trace, 99);
        _trace.open(vcdname);
      }
    }
  }

  void closetrace() {
    if (_trace !is null) {
      _trace.flush();
      _trace.close();
      _trace = null;
    }
  }

  override void doConnect() {
    import std.stdio;

    // Interface connections for Driver Side
    axis_in.clk(clk);
    axis_in.rst(rst);

    fifo_in.s_axis_tdata(dut.s_axis_tdata);
    fifo_in.s_axis_tlast(dut.s_axis_tlast);
    fifo_in.s_axis_tvalid(dut.s_axis_tvalid);
    fifo_in.s_axis_tready(dut.m_axis_tready);

    // Interface connections for Monitor Side
    fifo_out.clk(clk);
    fifo_out.rst(rst);


    fifo_out.s_axis_tdata(dut.m_axis_tdata);
    fifo_out.s_axis_tlast(dut.m_axis_last);
    fifo_out.s_axis_tvalid(dut.m_axis_tvalid);
    fifo_out.s_axis_tready(dut.s_axis_tready);

  }

  override void doBuild() {
    dut = new DVfifo_adder();
    opentrace("fifo_adder.vcd");
  }
  
  override void doFinish() {
    closetrace();
  }
  
  Task!stimulateClock stimulateClockTask;
  Task!stimulateReset stimulateResetTask;
  
  void stimulateClock() {
    while (true) {
      clk = false;
      dut.clk = false;
      wait (1.nsec);
      dut.eval();
      if (_trace !is null) _trace.dump(getSimTime().getVal());
      wait (4.nsec);
      clk = true;
      dut.clk = true;
      wait (1.nsec);
      dut.eval();
      if (_trace !is null) _trace.dump(getSimTime().getVal());
      wait (4.nsec);
    }
  }

  void stimulateReset() {
    rst = true;
    dut.rst = false;
    wait (100.nsec);
    rst = false;
    dut.rst = true;
  }

}

class uvm_adder_tb: uvm_context
{
  Top top;
  override void initial() {
    uvm_config_db!(fifo_intf).set(null, "uvm_test_top.env.agent.driver", "fifo_in", top.fifo_in);
    uvm_config_db!(fifo_intf).set(null, "uvm_test_top.env.agent.in_monitor", "fifo", top.fifo_in);
    uvm_config_db!(fifo_intf).set(null, "uvm_test_top.env.agent.out_monitor", "fifo", top.fifo_out);
  }
}

void main(string[] args) {
  import std.stdio;
  uint random_seed;

  CommandLine cmdl = new CommandLine(args);

  if (cmdl.plusArgs("random_seed=" ~ "%d", random_seed))
    writeln("Using random_seed: ", random_seed);
  else random_seed = 1;

  auto tb = new uvm_adder_tb;
  tb.elaborate("tb", args);
  tb.set_seed(random_seed);
  tb.start();
}


}